<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.linlong.f10.resource.geniusdao.ShareHolderDAO">
	<!-- 根据stocode查询控股情况 -->
	<select id="selectHoldSitu" resultType="java.util.HashMap"
		parameterType="String">
		SELECT
		A.CHANGEDATE AS changedate,
		A.TOT_HLD AS totHolder,
		A.A_HLD,
		CASE
		WHEN
		A.A_HLD = 0
		THEN NULL
		ELSE C.FL_ASHR / A.A_HLD
		END AS
		A_PR_SH,
		100 * (
		CASE
		WHEN A.A_HLD = 0
		THEN NULL
		ELSE C.FL_ASHR / A.A_HLD
		END
		) /
		(
		CASE
		WHEN D.A_HLD = 0
		THEN NULL
		ELSE E.FL_ASHR / D.A_HLD
		END
		) - 100
		AS
		A_SH_RA,
		ROUND(C.FL_ASHR / 10000, 2) AS flashr,
		A.TOT_HLD,
		A.B_HLD,
		CASE
		WHEN A.B_HLD = 0
		OR C.B_SHR IS NULL
		THEN NULL
		ELSE C.B_SHR / A.B_HLD
		END
		AS B_PR_SH,
		100 * (
		CASE
		WHEN A.B_HLD = 0
		OR C.B_SHR IS NULL
		THEN NULL
		ELSE C.B_SHR / A.B_HLD
		END
		) / (
		CASE
		WHEN D.B_HLD = 0
		OR E.B_SHR
		IS NULL
		THEN NULL
		ELSE E.B_SHR / D.B_HLD
		END
		) - 100 AS B_SH_RA,
		ROUND(C.B_SHR /
		10000, 2) AS B_SHR,
		A.TOT_HLD,
		CASE
		WHEN A.TOT_HLD = 0
		THEN NULL
		ELSE
		C.FL_SHR / A.TOT_HLD
		END AS pershr,
		100 * (
		CASE
		WHEN A.TOT_HLD = 0
		THEN
		NULL
		ELSE C.FL_SHR / A.TOT_HLD
		END
		) / (
		CASE
		WHEN D.TOT_HLD = 0
		THEN
		NULL
		ELSE E.FL_SHR / D.TOT_HLD
		END
		) - 100 AS tshrChange,
		ROUND(C.FL_SHR /
		10000, 2) AS FL_SHR -- 流通股(万股)
		FROM
		PGENIUS.STK_HOLDER_NUM A,
		PGENIUS.STK_CODE B,
		PGENIUS.STK_SHR_STRU C,
		PGENIUS.STK_HOLDER_NUM D,
		PGENIUS.STK_SHR_STRU E
		WHERE A.ISVALID = 1
		AND
		B.ISVALID = 1
		AND C.ISVALID
		= 1
		AND D.ISVALID = 1
		AND E.ISVALID = 1
		AND
		A.COMCODE = B.COMCODE
		AND
		B.COMCODE = C.COMCODE
		AND A.COMCODE =
		D.COMCODE
		AND C.COMCODE = E.COMCODE
		AND C.CHANGEDATE =
		(SELECT
		MAX(CHANGEDATE)
		FROM
		PGENIUS.STK_SHR_STRU
		WHERE
		ISVALID = 1
		AND COMCODE =
		C.COMCODE
		AND CHANGEDATE &lt;= A.CHANGEDATE)
		AND D.CHANGEDATE =
		(SELECT
		MAX(CHANGEDATE)
		FROM
		PGENIUS.STK_HOLDER_NUM
		WHERE ISVALID = 1
		AND COMCODE
		= A.COMCODE
		AND CHANGEDATE &lt;
		A.CHANGEDATE)
		AND E.CHANGEDATE =
		(SELECT
		MAX(CHANGEDATE)
		FROM
		PGENIUS.STK_SHR_STRU
		WHERE ISVALID = 1
		AND COMCODE =
		C.COMCODE
		AND
		CHANGEDATE &lt;= D.CHANGEDATE)
		AND B.STOCKCODE = #{stockcode}
		ORDER BY
		A.CHANGEDATE DESC
		LIMIT 10 ;
	</select>
	<select id="selectTotHolders" resultType="java.util.HashMap"
		parameterType="String">SELECT
		A.CHANGEDATE as changedate,
		A.TOT_HLD as totHolder
		FROM PGENIUS.STK_HOLDER_NUM A, PGENIUS.STK_CODE B
		WHERE A.ISVALID=1 AND
		B.ISVALID=1
		AND A.COMCODE=B.COMCODE
		AND B.STOCKCODE=#{stockcode}
		ORDER BY
		A.CHANGEDATE DESC
		LIMIT 1;
	</select>
	<select id="selectNewHolders" resultType="java.util.HashMap"
		parameterType="String">
		SELECT
		A.ENDDATE AS enddate,
		A.RANK AS rank,
		A.NAME AS	name,
		ROUND(A.HOLD_NUM/10000,2) AS holdNum,
		A.HOLD_PCT AS holdPct,
		(SELECT REF_NAME FROM PGENIUS.GEN_REF WHERE ISVALID=1 AND
		REF_CODE=A.SHR_CLS_CODE AND CLS_CODE=7003) AS shrCls,
		(CASE WHEN
		A.HOLD_NUM IS NOT NULL AND C.HOLD_NUM IS NOT NULL AND
		A.HOLD_NUM=C.HOLD_NUM
		THEN '无变动'
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NOT NULL AND
		A.HOLD_NUM!=C.HOLD_NUM
		THEN
		(A.HOLD_NUM-C.HOLD_NUM)/10000
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NULL
		THEN '新进' END) AS holdchange
		FROM
		PGENIUS.STK_SHR_CLS_DTL A
		INNER JOIN PGENIUS.STK_CODE B
		ON B.ISVALID=1
		AND A.COMCODE=B.COMCODE AND B.STOCKCODE=#{stockcode}
		LEFT JOIN
		PGENIUS.STK_SHR_CLS_DTL C
		ON C.ISVALID=1
		AND C.COMCODE=A.COMCODE AND
		C.ENDDATE=(SELECT MAX(ENDDATE) FROM
		PGENIUS.STK_SHR_CLS_DTL WHERE
		ISVALID=1 AND COMCODE=A.COMCODE AND
		ENDDATE
		&lt; A.ENDDATE ) AND A.NAME =C.NAME WHERE A.ISVALID=1 AND
		A.ENDDATE=(SELECT MAX(ENDDATE) FROM PGENIUS.STK_SHR_CLS_DTL WHERE
		ISVALID=1 AND COMCODE=A.COMCODE);
	</select>
	<select id="selectFloatHolders" resultType="java.util.HashMap"
		parameterType="String">
		SELECT
		A.ENDDATE AS enddate,
		A.RANK AS rank,
		A.NAME AS name,
		ROUND(A.HOLD_NUM/10000,2) AS holdNum,
		A.HOLD_PCT AS holdPct,
		(SELECT REF_NAME FROM PGENIUS.GEN_REF WHERE ISVALID=1 AND
		REF_CODE=A.SHR_CLS_CODE AND CLS_CODE=7003) AS shrCls,
		CASE WHEN
		A.HOLD_NUM IS NOT NULL AND C.HOLD_NUM IS NOT NULL AND
		A.HOLD_NUM=C.HOLD_NUM
		THEN '无变动'
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NOT NULL AND
		A.HOLD_NUM!=C.HOLD_NUM
		THEN
		(A.HOLD_NUM-C.HOLD_NUM)/10000
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NULL
		THEN '新进' END AS holdchange 
		FROM
		PGENIUS.STK_CIR_CLS_DTL A
		INNER JOIN PGENIUS.STK_CODE B
		ON B.ISVALID=1
		AND A.COMCODE=B.COMCODE AND B.STOCKCODE=#{stockcode}
		LEFT JOIN
		PGENIUS.STK_CIR_CLS_DTL C
		ON C.ISVALID=1
		AND C.COMCODE=A.COMCODE AND
		C.ENDDATE=(SELECT MAX(ENDDATE) FROM
		PGENIUS.STK_CIR_CLS_DTL WHERE
		ISVALID=1 AND COMCODE=A.COMCODE AND
		ENDDATE
		&lt; A.ENDDATE ) AND A.NAME =C.NAME WHERE A.ISVALID=1 AND
		A.ENDDATE=(SELECT MAX(ENDDATE) FROM PGENIUS.STK_SHR_CLS_DTL WHERE
		ISVALID=1 AND COMCODE=A.COMCODE);
	</select>
	<select id="selectTotalShare" resultType="String" parameterType="String">
		SELECT
		CONCAT('持有',(SELECT REF_NAME FROM PGENIUS.GEN_REF WHERE
		ISVALID=1 AND
		REF_CODE=A.SHR_CLS_CODE AND CLS_CODE=7003),
		ROUND(SUM(A.HOLD_NUM)/10000,2),'万，占总股本',ROUND(100*SUM(A.HOLD_NUM)/D.TOTAL,2),'%,占',
		(SELECT REF_NAME FROM PGENIUS.GEN_REF WHERE ISVALID=1 AND
		REF_CODE=A.SHR_CLS_CODE AND CLS_CODE=7003),
		(CASE A.SHR_CLS_CODE WHEN 5
		THEN ROUND(100*SUM(A.HOLD_NUM)/D.FL_ASHR,2)
		WHEN 6 THEN
		ROUND(SUM(100*A.HOLD_NUM)/D.B_SHR,2)
		WHEN 8 THEN
		ROUND(SUM(100*A.HOLD_NUM)/D.H_SHR,2)
		WHEN 10 THEN
		ROUND(SUM(100*A.HOLD_NUM)/D.FL_SHR,2)
		WHEN 9 THEN
		ROUND(SUM(100*A.HOLD_NUM)/D.FRGN_SHR,2) END),'%') AS
		totalShare
		FROM
		PGENIUS.STK_CIR_CLS_DTL A
		INNER JOIN PGENIUS.STK_CODE B
		ON B.ISVALID=1
		AND A.COMCODE=B.COMCODE AND B.STOCKCODE=#{stockcode}
		LEFT JOIN
		PGENIUS.STK_CIR_CLS_DTL C
		ON C.ISVALID=1
		AND C.COMCODE=A.COMCODE AND
		C.ENDDATE=(SELECT MAX(ENDDATE) FROM
		PGENIUS.STK_CIR_CLS_DTL WHERE
		ISVALID=1 AND COMCODE=A.COMCODE AND
		ENDDATE
		&lt; A.ENDDATE ) AND A.NAME =C.NAME LEFT JOIN
		PGENIUS.STK_SHR_STRU D ON D.ISVALID=1 AND
		D.COMCODE=A.COMCODE AND
		D.CHANGEDATE=(SELECT MAX(CHANGEDATE) FROM
		PGENIUS.STK_SHR_STRU
		WHERE COMCODE=D.COMCODE AND ISVALID=1 AND
		CHANGEDATE&lt;=A.ENDDATE)
		WHERE A.ISVALID=1
		AND A.ENDDATE=(SELECT
		MAX(ENDDATE) FROM PGENIUS.STK_SHR_CLS_DTL WHERE
		ISVALID=1 AND
		COMCODE=A.COMCODE)
		GROUP BY A.SHR_CLS_CODE LIMIT 1;
	</select>
	<select id="selectLimitHolders" resultType="java.util.HashMap"
		parameterType="String">
		SELECT
		DATE(A.ENDDATE) AS enddate,
		A.RANK AS rank,
		A.NAME AS NAME,
		ROUND(A.HOLD_NUM/10000,2) AS holdNum,
		ROUND(A.HOLD_PCT,3) AS holdPct,
		'限售股份' AS property,
		CASE WHEN a.ADD_NUM
		=0 THEN '无变动' ELSE
		ROUND(A.ADD_NUM/10000,2) END AS
		holdchange
		FROM
		PGENIUS.STK_RST_HOLDER A
		INNER JOIN PGENIUS.STK_CODE B ON B.ISVALID=1
		AND A.COMCODE=B.COMCODE
		WHERE A.ISVALID=1
		AND A.ENDDATE=(SELECT
		MAX(ENDDATE) FROM
		PGENIUS.STK_RST_HOLDER WHERE
		ISVALID=1 AND
		COMCODE=A.COMCODE)
		AND
		B.STOCKCODE=#{stockcode}
		ORDER BY HOLD_NUM DESC
		LIMIT 10 ;
	</select>

	<select id="selectHisDate" resultType="java.util.Date"
		parameterType="String">SELECT DISTINCT ENDDATE
		FROM PGENIUS.STK_SHR_CLS_DTL
		WHERE ISVALID=1 AND COMCODE=(SELECT COMCODE FROM PGENIUS.STK_CODE
		WHERE
		ISVALID=1 AND STOCKCODE=#{stockcode})
		ORDER BY ENDDATE DESC LIMIT
		3;
	</select>
	<select id="selectHisTotHolders" resultType="java.util.HashMap">
		SELECT A.CHANGEDATE
		AS changedate, A.TOT_HLD AS totHolder
		FROM PGENIUS.STK_HOLDER_NUM
		A,PGENIUS.STK_CODE B
		WHERE A.ISVALID=1 AND B.ISVALID=1 AND
		A.COMCODE=B.COMCODE
		AND B.STOCKCODE=#{stockcode}
		AND
		A.CHANGEDATE=(SELECT MAX(CHANGEDATE) FROM PGENIUS.STK_HOLDER_NUM
		WHERE
		ISVALID=1 AND comcode=a.comcode AND CHANGEDATE&lt;=#{changedate});
	</select>
	<select id="selectHisNewHolders" resultType="java.util.HashMap">
		SELECT
		A.ENDDATE as
		enddate,A.RANK as rank,A.NAME as name,ROUND(A.HOLD_NUM/10000,2) AS
		holdNum,
		A.HOLD_PCT as holdPct,(SELECT REF_NAME FROM PGENIUS.GEN_REF
		WHERE
		ISVALID=1 AND
		REF_CODE=A.SHR_CLS_CODE AND CLS_CODE=7003) AS
		shrCls,
		CASE WHEN
		A.HOLD_NUM IS NOT NULL AND C.HOLD_NUM IS NOT NULL AND
		A.HOLD_NUM=C.HOLD_NUM THEN '无变动'
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NOT NULL AND
		A.HOLD_NUM!=C.HOLD_NUM THEN
		ROUND((A.HOLD_NUM-C.HOLD_NUM)/10000,2)
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NULL THEN '新进' END as holdchange
		FROM PGENIUS.STK_SHR_CLS_DTL
		A
		INNER
		JOIN PGENIUS.STK_CODE B
		ON B.ISVALID=1 AND A.COMCODE=B.COMCODE
		AND
		B.STOCKCODE=#{stockcode}
		LEFT JOIN PGENIUS.STK_SHR_CLS_DTL C
		ON
		C.ISVALID=1
		AND A.NAME=C.NAME
		AND C.COMCODE=A.COMCODE AND
		C.ENDDATE=(SELECT
		MAX(ENDDATE) FROM
		PGENIUS.STK_SHR_CLS_DTL WHERE
		ISVALID=1 AND
		COMCODE=A.COMCODE AND
		ENDDATE
		&lt;A.ENDDATE ) WHERE
		A.ISVALID=1 AND
		A.ENDDATE=#{changedate};
	</select>
	<select id="selectHisFloatHolders" resultType="java.util.HashMap">
		SELECT A.ENDDATE
		as enddate,A.RANK as rank,A.NAME as
		name,ROUND(A.HOLD_NUM/10000,2) AS
		holdNum,
		A.HOLD_PCT as holdPct,(SELECT REF_NAME FROM PGENIUS.GEN_REF
		WHERE ISVALID=1 AND
		REF_CODE=A.SHR_CLS_CODE AND CLS_CODE=7003) AS
		shrCls,
		CASE WHEN A.HOLD_NUM IS NOT NULL AND C.HOLD_NUM IS NOT NULL
		AND
		A.HOLD_NUM=C.HOLD_NUM THEN '无变动'
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NOT NULL AND
		A.HOLD_NUM!=C.HOLD_NUM
		THEN
		round((A.HOLD_NUM-C.HOLD_NUM)/10000,2)
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NULL THEN '新进' END as holdchange
		FROM PGENIUS.STK_CIR_CLS_DTL
		A
		INNER JOIN PGENIUS.STK_CODE B
		ON B.ISVALID=1 AND A.COMCODE=B.COMCODE
		AND B.STOCKCODE=#{stockcode}
		LEFT JOIN PGENIUS.STK_CIR_CLS_DTL C ON
		C.ISVALID=1 AND A.NAME=C.NAME
		AND C.COMCODE=A.COMCODE AND
		C.ENDDATE=(SELECT MAX(ENDDATE) FROM
		PGENIUS.STK_CIR_CLS_DTL WHERE
		ISVALID=1 AND COMCODE=A.COMCODE AND
		ENDDATE
		&lt;A.ENDDATE ) WHERE
		A.ISVALID=1 AND A.ENDDATE=#{changedate};
	</select>
	<select id="selectHisTotalShare" resultType="String">
		SELECT
		CONCAT('持有',(SELECT REF_NAME FROM PGENIUS.GEN_REF WHERE ISVALID=1 AND
		REF_CODE=A.SHR_CLS_CODE AND CLS_CODE=7003),
		ROUND(SUM(A.HOLD_NUM)/10000,2),'万，占总股本',ROUND(100*SUM(A.HOLD_NUM)/D.TOTAL,2),'%,占',
		(SELECT REF_NAME FROM PGENIUS.GEN_REF WHERE ISVALID=1 AND
		REF_CODE=A.SHR_CLS_CODE AND CLS_CODE=7003),
		(CASE A.SHR_CLS_CODE WHEN 5
		THEN ROUND(100*SUM(A.HOLD_NUM)/D.FL_ASHR,2)
		WHEN 6 THEN
		ROUND(SUM(100*A.HOLD_NUM)/D.B_SHR,2)
		WHEN 8 THEN
		ROUND(SUM(100*A.HOLD_NUM)/D.H_SHR,2)
		WHEN 10 THEN
		ROUND(SUM(100*A.HOLD_NUM)/D.FL_SHR,2)
		WHEN 9 THEN
		ROUND(SUM(100*A.HOLD_NUM)/D.FRGN_SHR,2) END),'%') as
		totalShare
		FROM
		PGENIUS.STK_CIR_CLS_DTL A
		INNER JOIN PGENIUS.STK_CODE B
		ON B.ISVALID=1
		AND A.COMCODE=B.COMCODE AND B.STOCKCODE=#{stockcode}
		LEFT JOIN
		PGENIUS.STK_CIR_CLS_DTL C
		ON C.ISVALID=1
		AND C.COMCODE=A.COMCODE AND
		C.ENDDATE=(SELECT MAX(ENDDATE) FROM
		PGENIUS.STK_CIR_CLS_DTL WHERE
		ISVALID=1 AND COMCODE=A.COMCODE AND
		ENDDATE&lt;A.ENDDATE)
		AND
		A.NAME=C.NAME
		LEFT JOIN PGENIUS.STK_SHR_STRU D ON D.ISVALID=1 AND
		D.COMCODE=A.COMCODE
		AND D.CHANGEDATE=(SELECT MAX(CHANGEDATE) FROM
		PGENIUS.STK_SHR_STRU
		WHERE COMCODE=D.COMCODE AND ISVALID=1 AND
		CHANGEDATE&lt;=A.ENDDATE)
		WHERE A.ISVALID=1 AND A.ENDDATE=#{changedate}
		GROUP BY A.SHR_CLS_CODE LIMIT 1;
	</select>
	<select id="selectHisLimitHolders" resultType="java.util.HashMap">
		SELECT
		DATE(A.ENDDATE) as enddate,
		A.RANK as rank,
		A.NAME as name,
		ROUND(A.HOLD_NUM/10000,2) AS holdNum,
		ROUND(A.HOLD_PCT,2) AS holdPct,
		'限售股份' AS 股份性质,
		CASE WHEN A.HOLD_NUM IS NOT NULL AND C.HOLD_NUM IS NOT
		NULL AND
		ROUND(A.HOLD_NUM=C.HOLD_NUM,2) THEN '无变动'
		WHEN A.HOLD_NUM IS
		NOT NULL AND C.HOLD_NUM IS NOT NULL AND
		A.HOLD_NUM!=C.HOLD_NUM THEN
		ROUND((A.HOLD_NUM-C.HOLD_NUM)/10000,2)
		WHEN A.HOLD_NUM IS NOT NULL AND
		C.HOLD_NUM IS NULL THEN '新进' END AS
		holdchange
		FROM
		PGENIUS.STK_RST_HOLDER A
		INNER JOIN PGENIUS.STK_CODE B
		ON B.ISVALID=1
		AND A.COMCODE=B.COMCODE
		LEFT JOIN PGENIUS.STK_RST_HOLDER C
		ON
		C.ISVALID=1 AND C.COMCODE=A.COMCODE AND A.NAME=C.NAME
		WHERE
		A.ISVALID=1
		AND A.ENDDATE=#{changedate}
		AND C.ENDDATE=(SELECT MAX(ENDDATE)
		FROM PGENIUS.STK_RST_HOLDER WHERE
		ISVALID=1 AND COMCODE=A.COMCODE AND
		ENDDATE&lt;A.ENDDATE)
		AND B.STOCKCODE=#{stockcode}
	</select>
</mapper>